<!DOCTYPE html>
<html lang="en" data-theme="light" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.12.0/dist/cdn.min.js" defer></script>
    <link rel="icon" href="/static/eitr.ico" type="image/x-icon">
    <title>EITR - Terraform Config Generator</title>
    <style>
        .text-shadow {
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.75);
        }
        .highlight {
            font-size: 2rem;
            color: yellow;
            font-weight: bold;
            font-style: italic;
        }
        .title {
            font-family: Arial, sans-serif;
            font-size: 1rem;
            display: block;
            margin: 10px 10px 0 0;
            padding: 5px 10px;
            align-items: baseline;
        }
        .word {
            margin: 0 0.3rem;
        }
    </style>
</head>
<body class="bg-cover bg-center h-full relative">
    <!-- Background Image -->
    <div class="fixed inset-0 z-0">
        <img src="static/eitr_background.jpeg" alt="Background image of EITR" class="object-cover w-full h-full">
    </div>

    <!-- Header -->
    <header class="relative z-50 bg-opacity-99 text-white p-4 text-center">
        <div class="relative inline-block">
            <center>
                <img 
                    src="static/eitr.png" 
                    alt="EITR logo" 
                    width="10%" 
                    height="10%" 
                    class="cursor-pointer" 
                    id="eitrImage">
                <h1 class="title">
                    <span class="highlight">E</span><span class="word">nvironment</span>
                    <span class="highlight">I</span><span class="word">nfrastructure</span>
                    <span class="highlight">T</span><span class="word">erraform</span>
                    <span class="highlight">R</span><span class="word">enderer</span>
                </h1>
            </center>
            <div id="hoverText" class="absolute hidden bg-gray-700 text-white text-sm rounded p-4 w-[500px] max-w-none mt-4 shadow-lg z-50">
                In Norse mythology, <i>eitr</i> (pronounced as "ater" or "either") is a substance representing raw potential and creation. The perfect name for a tool that helps shape and define infrastructure.
            </div>
        </div>
    </header>

    <!-- Main Layout -->
    <div x-data="{ isSidebarOpen: true }" class="relative z-10 flex h-full">
        <!-- Sidebar Navbar -->
        <nav 
            class="w-full md:w-1/6 bg-opacity-99 text-white overflow-y-auto h-full p-4 transition-transform duration-300 transform md:translate-x-0" 
            :class="{ '-translate-x-full': !isSidebarOpen }">
            <button 
                class="block md:hidden mb-4 text-white bg-gray-700 px-4 py-2 rounded" 
                @click="isSidebarOpen = !isSidebarOpen">
                Toggle Sidebar
            </button>
            <h2 class="text-2xl font-bold mb-4 text-center">Providers</h2>
            <p class="text-white-300 mb-6"><i>Select a provider and its resources to start generating Terraform configuration.</i></p>
            <div>
                {% for provider in providers %}
                <div x-data="{ open: false }" class="mb-4">
                    <button 
                        @click="open = !open" 
                        class="w-full text-left px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded">
                        {{ provider.description }}
                    </button>
                    <div x-show="open" x-transition class="mt-2 pl-4 space-y-4">
                        {% for schema_type, items in provider.schemas.items() %}
                        {% if items|length > 0 %}
                        <div>
                            <h4 class="text-gray-400 font-semibold capitalize">{{ schema_type.replace('_', ' ') }}</h4>
                            <div class="pl-4 space-y-2">
                                {% if schema_type == 'provider' %}
                                <label class="flex items-center space-x-2">
                                    <input type="checkbox"
                                           name="{{ provider.name }}_{{ schema_type }}"
                                           value="config"
                                           class="resource-checkbox"
                                           data-resource="config"
                                           data-provider="{{ provider.name }}">
                                    <span>config</span>
                                </label>
                                {% else %}
                                {% for item in items %}
                                <label class="flex items-center space-x-2">
                                    <input type="checkbox" 
                                           name="{{ provider.name }}_{{ schema_type }}" 
                                           value="{{ item }}" 
                                           class="resource-checkbox" 
                                           data-resource="{{ item }}"
                                           data-provider="{{ provider.name }}">
                                    <span>{{ item }}</span>
                                </label>
                                {% endfor %}
                                {% endif %}
                            </div>
                        </div>
                        {% endif %}
                        {% endfor %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </nav>

        <!-- Main Content -->
        <main class="w-full md:w-5/6 bg-opacity-99 p-6 overflow-y-auto">
            <div class="mt-6 hidden" id="save-buttons">
                <button
                    class="bg-green-500 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded inline-flex items-center"
                    id="saveJsonBtn">
                    <svg class="fill-current w-4 h-4 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20">
                        <path d="M13 8V2H7v6H2l8 8 8-8h-5zM0 18h20v2H0v-2z"/>
                    </svg>
                    <span>Save as JSON</span>
                </button>
                <button
                    class="bg-green-500 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded inline-flex items-center"
                    id="saveHclBtn">
                    <svg class="fill-current w-4 h-4 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20">
                        <path d="M13 8V2H7v6H2l8 8 8-8h-5zM0 18h20v2H0v-2z"/>
                    </svg>
                    <span>Save as HCL</span>
                </button>
                <button
                    class="bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded inline-flex items-center"
                    id="resetConfigBtn">
                    <svg class="fill-current w-4 h-4 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20">
                        <path d="M10 2a8 8 0 100 16 8 8 0 000-16zM5 10H3v1h2v-1zm6-7h-1v2h1V3zm6 7h-2v1h2v-1zM7.222 6.222l-1.415 1.415L6.364 8.293l1.415-1.415-1.414-1.415zM15.778 13.778l-1.415-1.415-1.414 1.415 1.415 1.414 1.414-1.414zM4.222 15.778l-1.414 1.415 1.415 1.414 1.414-1.414-1.415-1.415zM16.222 4.222l-1.415-1.415-1.414 1.415 1.415 1.414 1.414-1.414z"/>
                    </svg>
                    <span>Reset Config</span>
                </button>
            </div>
            <div id="config-display" class="space-y-4"></div>
        </main>
    </div>

    <!-- Footer -->
    <footer class="relative z-10 bg-opacity-90 text-white p-4 text-left">
        <p>
            Providers: {{ total_providers }}, Resources: {{ total_resources }}
        </p>
        <p>EITR &copy; <span id="current-year"></span> Dayton Jones</p>
    </footer>
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const resourceCheckboxes = document.querySelectorAll(".resource-checkbox");
            const configDisplay = document.getElementById("config-display");
            const saveButtons = document.getElementById("save-buttons");
    
            // Fetch the template for a specific resource
            const fetchTemplate = async (provider, schemaType, resource) => {
                try {
                    const response = await fetch(`/load_templates/${provider}/${schemaType}/${resource}`);
                    if (!response.ok) throw new Error("Failed to load template");
    
                    const data = await response.json();
                    return data[schemaType] || "No template found";
                } catch (error) {
                    console.error(`Error loading template for ${provider} - ${schemaType} - ${resource}:`, error);
                    return "Error loading template.";
                }
            };
    
            // Refresh the configuration display with templates
            const refreshConfigDisplay = async () => {
                configDisplay.innerHTML = ""; // Clear current display
                const response = await fetch("/get_current_config");
                if (!response.ok) throw new Error("Failed to fetch current config");
                const { config } = await response.json();
            
                for (const [provider, schemas] of Object.entries(config)) {
                    const providerSection = document.createElement("div");
                    providerSection.className = "p-4 bg-gray-700 rounded mb-4";
            
                    // Add a button for collapsing and expanding
                    const providerHeader = document.createElement("button");
                    providerHeader.className = "w-full text-left text-lg font-bold text-white px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded";
                    providerHeader.innerHTML = `:: ${provider.toUpperCase()} ::`;
                    providerHeader.addEventListener("click", () => {
                        providerContent.classList.toggle("hidden"); // Toggle visibility
                    });
            
                    // Content section that can be toggled
                    const providerContent = document.createElement("div");
                    providerContent.className = "mt-2 space-y-4";
            
                    // Handle "provider" schema type first
                    if (schemas.provider) {
                        const schemaSection = document.createElement("div");
                        schemaSection.className = "mb-2";
                        schemaSection.innerHTML = `<h4 class="font-semibold text-gray-300 capitalize">provider</h4>`;
                        for (const resource of schemas.provider) {
                            const templateContent = await fetchTemplate(provider, "provider", resource);
                            const resourceDiv = document.createElement("div");
                            resourceDiv.className = "p-2 bg-gray-800 rounded mt-2";
                            resourceDiv.innerHTML = `
                                <h5 class="text-sm font-bold text-gray-200">${resource}</h5>
                                <pre class="text-xs bg-gray-900 text-white p-2 rounded overflow-auto">${templateContent}</pre>
                            `;
                            schemaSection.appendChild(resourceDiv);
                        }
                        providerContent.appendChild(schemaSection);
                    }
            
                    // Handle all other schema types
                    for (const [schemaType, resources] of Object.entries(schemas)) {
                        if (schemaType === "provider") continue; // Already handled
                        const schemaSection = document.createElement("div");
                        schemaSection.className = "mb-2";
                        schemaSection.innerHTML = `<h4 class="font-semibold text-gray-300 capitalize">${schemaType}</h4>`;
                        for (const resource of resources) {
                            const templateContent = await fetchTemplate(provider, schemaType, resource);
                            const resourceDiv = document.createElement("div");
                            resourceDiv.className = "p-2 bg-gray-800 rounded mt-2";
                            resourceDiv.innerHTML = `
                                <h5 class="text-sm font-bold text-gray-200">${resource}</h5>
                                <pre class="text-xs bg-gray-900 text-white p-2 rounded overflow-auto">${templateContent}</pre>
                            `;
                            schemaSection.appendChild(resourceDiv);
                        }
                        providerContent.appendChild(schemaSection);
                    }
            
                    // Append the header and content to the provider section
                    providerSection.appendChild(providerHeader);
                    providerSection.appendChild(providerContent);
            
                    // Add the provider section to the display
                    configDisplay.appendChild(providerSection);
                }
            
                saveButtons.style.display = configDisplay.children.length > 0 ? "block" : "none";
            };
 
            // Update the in-memory configuration
            const updateConfig = async (provider, schemaType, resource, action) => {
                try {
                    await fetch("/update_config", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ provider, schema_type: schemaType, resource, action }),
                    });
                } catch (error) {
                    console.error("Error updating configuration:", error);
                }
            };
    
            // When a checkbox is toggled
            resourceCheckboxes.forEach((checkbox) => {
                checkbox.addEventListener("change", async () => {
                    const provider = checkbox.dataset.provider;
                    const resource = checkbox.dataset.resource;
                    const schemaType = checkbox.name.split("_")[1];
                    const action = checkbox.checked ? "add" : "remove";
    
                    await updateConfig(provider, schemaType, resource, action);
                    await refreshConfigDisplay();
                });
            });
    
            // Save configuration as JSON or HCL
            const saveConfig = async (format) => {
             // Collect all displayed templates from the configDisplay
             const templates = Array.from(configDisplay.querySelectorAll("pre"))
                 .map(pre => pre.innerText)
                 .join("\n\n");
         
             try {
                 const response = await fetch(`/save_config/${format}`, {
                     method: "POST",
                     headers: { "Content-Type": "application/json" },
                     body: JSON.stringify({ config: templates }),
                 });
         
                 if (response.ok) {
                     const { config } = await response.json();
                     const blob = new Blob([config], { type: format === "json" ? "application/json" : "application/x-hcl" });
                     const downloadUrl = window.URL.createObjectURL(blob);
                     const link = document.createElement("a");
                     link.href = downloadUrl;
                     link.download = `eitr_generated_tf_config_${new Date().toISOString().slice(0, 19).replace(/:/g, "-")}.${format}`;
                     document.body.appendChild(link);
                     link.click();
                     link.remove();
                 } else {
                     console.error(`Error saving ${format.toUpperCase()} configuration`);
                 }
             } catch (error) {
                 console.error("Error saving configuration:", error);
             }
         };
 
            document.getElementById("saveJsonBtn").addEventListener("click", () => saveConfig("json"));
            document.getElementById("saveHclBtn").addEventListener("click", () => saveConfig("hcl"));

            document.getElementById("resetConfigBtn").addEventListener("click", async () => {
                try {
                    // Clear the in-memory configuration on the backend
                    await fetch("/reset_config", {
                        method: "POST",
                    });
            
                    // Unselect all checkboxes
                    document.querySelectorAll(".resource-checkbox").forEach((checkbox) => {
                        checkbox.checked = false;
                    });
            
                    // Clear the main display
                    configDisplay.innerHTML = "";
            
                    // Hide save buttons
                    saveButtons.style.display = "none";
                } catch (error) {
                    console.error("Error resetting configuration:", error);
                }
            });

    
            // Update the current year in the footer
            document.getElementById("current-year").textContent = new Date().getFullYear();
    
            // Hover effect for logo
            const image = document.getElementById("eitrImage");
            const hoverText = document.getElementById("hoverText");
    
            image.addEventListener("mouseover", () => {
                hoverText.classList.remove("hidden");
            });
    
            image.addEventListener("mouseout", () => {
                hoverText.classList.add("hidden");
            });
    
            // Initial fetch to populate the display
            refreshConfigDisplay();
        });
    </script>
</body>
</html>

